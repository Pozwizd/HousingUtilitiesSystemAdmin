<!DOCTYPE html>
<html lang="en" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{template/layout.html}">

<head>
    <title>Дома</title>
    <th:block layout:fragment="page_css">

    </th:block>
</head>
<body>

<div layout:fragment="content">
    <div class="main-card mb-3 card" id="card-block">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h5 class="mb-0">Дома</h5>
            <a th:href="@{/houses/create}" class="btn btn-primary btn-sm">Добавить</a>
        </div>
        <div class="card-body">
            <div class="table-responsive">
                <table style="width: 100%;" class="table table-hover table-striped table-bordered">
                    <thead>
                    <tr>
                        <th>Номер дома</th>
                        <th>Улица</th>
                        <th>Город</th>
                        <th>Председатель</th>
                        <th>Статус</th>
                        <th>Действия</th>
                    </tr>
                    <!-- Filter Row -->
                    <tr>
                        <th><input type="text" class="form-control form-control-sm filter-input"
                                   data-filter-key="houseNumber" placeholder="Номер дома"></th>
                        <th><input type="text" class="form-control form-control-sm filter-input"
                                   data-filter-key="streetName" placeholder="Улица"></th>
                        <th><input type="text" class="form-control form-control-sm filter-input"
                                   data-filter-key="cityName" placeholder="Город"></th>
                        <th><input type="text" class="form-control form-control-sm filter-input"
                                   data-filter-key="chairmanFullName" placeholder="Председатель"></th>
                        <th><input type="text" class="form-control form-control-sm filter-input"
                                   data-filter-key="status" placeholder="Статус"></th>
                        <th class="text-center">
                            <button type="button" id="clearFiltersBtn" class="btn btn-light btn-sm">Очистить
                            </button>
                        </th>
                    </tr>
                    </thead>
                    <tbody id="houseTableBody">
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer d-flex justify-content-between align-items-center py-3">
            <label class="d-flex align-items-center gap-1 mb-0">
                <select id="pageSize" class="custom-select custom-select-sm form-control form-control-sm mx-2"
                        style="width: auto;">
                    <option value="10" selected>10</option>
                    <option value="25">25</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                </select>
            </label>
            <nav aria-label="Навигация по страницам">
                <ul class="pagination mb-0" id="pagination">

                </ul>
            </nav>
        </div>

        <div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deleteConfirmModalLabel">
                            Подтверждение удаления</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"
                                aria-label="Закрыть"></button>
                    </div>
                    <div class="modal-body">
                        <span>Вы уверены, что хотите удалить этот дом?</span>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-label-secondary"
                                data-bs-dismiss="modal" >Отменить
                        </button>
                        <button type="button" class="btn btn-danger" id="confirm-delete-btn">Удалить
                        </button>
                    </div>
                </div>
            </div>
        </div>



    </div>
</div>

<div>
    <th:block layout:fragment="page_js">
        <script>
            $(document).ready(function() {
                let currentPage = 0;
                let pageSize = 10;
                let currentFilters = {};
                let filterTimeout = null;

                function loadHouseTable() {
                    const requestData = {
                        page: currentPage,
                        size: pageSize
                    };

                    // Добавляем фильтры к запросу
                    Object.keys(currentFilters).forEach(key => {
                        if (currentFilters[key] && currentFilters[key].trim() !== '') {
                            requestData[key] = currentFilters[key].trim();
                        }
                    });

                    console.log('Отправка запроса с фильтрами:', requestData);

                    $.ajax({
                        url: '/houses/getAll',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(requestData),
                        success: function(response) {
                            console.log('Получен ответ:', response);
                            renderTable(response.content);
                            renderPagination(response);
                        },
                        error: function(xhr, status, error) {
                            console.error('Ошибка загрузки данных:', error);
                            console.error('Детали ошибки:', xhr.responseText);
                            if (typeof Swal !== 'undefined') {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Ошибка',
                                    text: 'Не удалось загрузить данные домов'
                                });
                            }
                        }
                    });
                }

                function renderTable(houses) {
                    const tbody = $('#houseTableBody');
                    tbody.empty();

                    if (!houses || houses.length === 0) {
                        tbody.append(`
                            <tr>
                                <td colspan="6" class="text-center py-4">
                                    <i class="icon-base ti tabler-home-off icon-lg mb-2"></i>
                                    <p class="mb-0">Дома не найдены</p>
                                </td>
                            </tr>
                        `);
                        return;
                    }

                    houses.forEach(house => {
                        // Форматирование статуса
                        const statusLabels = {
                            'NEW': '<span class="badge bg-info">Новый</span>',
                            'ACTIVE': '<span class="badge bg-success">Активный</span>',
                            'DEACTIVATED': '<span class="badge bg-warning">Деактивирован</span>',
                            'BLOCKED': '<span class="badge bg-danger">Заблокирован</span>'
                        };
                        const statusDisplay = statusLabels[house.status] || house.status || '';

                        const row = `
                    <tr>
                        <td>${house.houseNumber || '-'}</td>
                        <td>${house.streetName || '-'}</td>
                        <td>${house.cityName || '-'}</td>
                        <td>${house.chairmanFullName || '-'}</td>
                        <td>${statusDisplay}</td>
                        <td class="text-center">
                        <div class="dropdown">
                            <button type="button" class="btn p-0 dropdown-toggle hide-arrow" data-bs-toggle="dropdown">
                              <i class="icon-base ti tabler-dots-vertical"></i>
                            </button>
                            <div class="dropdown-menu">
                                  <a href="/houses/card/${house.id}" class="dropdown-item"><i
                                      class="icon-base ti tabler-eye me-1"></i> Просмотр</a>
                                  <a href="/houses/edit/${house.id}" class="dropdown-item"><i
                                      class="icon-base ti tabler-pencil me-1"></i> Редактировать</a>
                                  <button class="dropdown-item delete-btn" data-id="${house.id}" ><i
                                      class="icon-base ti tabler-trash me-1"></i> Удалить</button>
                            </div>
                        </div>
                        </td>
                    </tr>
                `;
                        tbody.append(row);
                    });
                }

                function renderPagination(pageData) {
                    const pagination = $('#pagination');
                    pagination.empty();

                    const totalPages = pageData.totalPages;
                    const currentPageNum = pageData.number;

                    // Кнопка "В начало"
                    const firstDisabled = currentPageNum === 0 ? 'disabled' : '';
                    pagination.append(`
                <li class="page-item first ${firstDisabled}">
                    <a class="page-link" href="#" data-page="0" ${firstDisabled ? 'aria-disabled="true"' : ''}>
                        <i class="icon-base ti tabler-chevrons-left icon-sm"></i>
                    </a>
                </li>
            `);

                    // Кнопка "Предыдущая"
                    const prevDisabled = currentPageNum === 0 ? 'disabled' : '';
                    pagination.append(`
                <li class="page-item prev ${prevDisabled}">
                    <a class="page-link" href="#" data-page="${currentPageNum - 1}" ${prevDisabled ? 'aria-disabled="true"' : ''}>
                        <i class="icon-base ti tabler-chevron-left icon-sm"></i>
                    </a>
                </li>
            `);

                    // Логика отображения номеров страниц
                    if (totalPages <= 7) {
                        // Если страниц мало, показываем все
                        for (let i = 0; i < totalPages; i++) {
                            const activeClass = i === currentPageNum ? 'active' : '';
                            pagination.append(`
                        <li class="page-item ${activeClass}">
                            <a class="page-link" href="#" data-page="${i}">${i + 1}</a>
                        </li>
                    `);
                        }
                    } else {
                        // Показываем первую страницу
                        const firstActive = currentPageNum === 0 ? 'active' : '';
                        pagination.append(`
                    <li class="page-item ${firstActive}">
                        <a class="page-link" href="#" data-page="0">1</a>
                    </li>
                `);

                        // Определяем диапазон страниц вокруг текущей
                        let startPage, endPage;
                        const pagesAround = 2;

                        if (currentPageNum <= 3) {
                            startPage = 1;
                            endPage = Math.min(5, totalPages - 2);
                        } else if (currentPageNum >= totalPages - 4) {
                            startPage = Math.max(totalPages - 6, 1);
                            endPage = totalPages - 2;
                        } else {
                            startPage = currentPageNum - pagesAround;
                            endPage = currentPageNum + pagesAround;
                        }

                        if (startPage > 1) {
                            pagination.append(`
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    `);
                        }

                        for (let i = startPage; i <= endPage; i++) {
                            const activeClass = i === currentPageNum ? 'active' : '';
                            pagination.append(`
                        <li class="page-item ${activeClass}">
                            <a class="page-link" href="#" data-page="${i}">${i + 1}</a>
                        </li>
                    `);
                        }

                        if (endPage < totalPages - 2) {
                            pagination.append(`
                        <li class="page-item disabled">
                            <span class="page-link">...</span>
                        </li>
                    `);
                        }

                        const lastActive = currentPageNum === totalPages - 1 ? 'active' : '';
                        pagination.append(`
                    <li class="page-item ${lastActive}">
                        <a class="page-link" href="#" data-page="${totalPages - 1}">${totalPages}</a>
                    </li>
                `);
                    }

                    // Кнопка "Следующая"
                    const nextDisabled = currentPageNum === totalPages - 1 ? 'disabled' : '';
                    pagination.append(`
                <li class="page-item next ${nextDisabled}">
                    <a class="page-link" href="#" data-page="${currentPageNum + 1}" ${nextDisabled ? 'aria-disabled="true"' : ''}>
                        <i class="icon-base ti tabler-chevron-right icon-sm"></i>
                    </a>
                </li>
            `);

                    // Кнопка "В конец"
                    const lastDisabled = currentPageNum === totalPages - 1 ? 'disabled' : '';
                    pagination.append(`
                <li class="page-item last ${lastDisabled}">
                    <a class="page-link" href="#" data-page="${totalPages - 1}" ${lastDisabled ? 'aria-disabled="true"' : ''}>
                        <i class="icon-base ti tabler-chevrons-right icon-sm"></i>
                    </a>
                </li>
            `);
                }

                $(document).on('click', '.page-link', function(e) {
                    e.preventDefault();
                    currentPage = parseInt($(this).data('page'));
                    loadHouseTable();
                });

                $('#pageSize').change(function() {
                    pageSize = parseInt($(this).val());
                    currentPage = 0;
                    loadHouseTable();
                });

                $('.filter-input').on('input', function() {
                    const filterKey = $(this).data('filter-key');
                    const filterValue = $(this).val();

                    // Очистка предыдущего таймера
                    if (filterTimeout) {
                        clearTimeout(filterTimeout);
                    }

                    // Обновление фильтров
                    if (filterValue && filterValue.trim() !== '') {
                        currentFilters[filterKey] = filterValue.trim();
                    } else {
                        delete currentFilters[filterKey];
                    }

                    // Debounce: ждем 500мс после последнего ввода
                    filterTimeout = setTimeout(function() {
                        currentPage = 0;
                        console.log('Применение фильтров:', currentFilters);
                        loadHouseTable();
                    }, 500);
                });

                $('#clearFiltersBtn').click(function() {
                    $('.filter-input').val('');
                    currentFilters = {};
                    currentPage = 0;
                    loadHouseTable();
                });

                $(document).on('click', '.delete-btn', function() {
                    const houseId = $(this).data('id');
                    $('#confirm-delete-btn').data('id', houseId);
                    $('#deleteConfirmModal').modal('show');
                });

                $('#confirm-delete-btn').click(function() {
                    const houseId = $(this).data('id');

                    $.ajax({
                        url: `/houses/${houseId}`,
                        type: 'DELETE',
                        success: function() {
                            $('#deleteConfirmModal').modal('hide');
                            showToast('success', 'Успех', 'Дом успешно удален');
                            loadHouseTable();
                        },
                        error: function(xhr, status, error) {
                            console.error('Ошибка удаления:', error);
                            $('#deleteConfirmModal').modal('hide');
                            showToast('error', 'Ошибка', 'Не удалось удалить дом');
                        }
                    });
                });

                loadHouseTable();
            });
        </script>
    </th:block>
</div>


</body>
</html>

