<!DOCTYPE html>
<html lang="en" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{template/layout.html}">

<head>
    <title>Дома</title>
    <th:block layout:fragment="page_css">

    </th:block>
</head>
<body>

<div layout:fragment="content">
    <div class="row">
        <div class="col-md-12">
            <div class="card mb-6">
                <h5 class="card-header">Новый дом</h5>
                <form id="formHouseSettings">
                    <div class="card-body pt-4">
                        <input type="hidden" id="houseId" name="id"/>
                        <div class="row gy-4 gx-6 mb-3">
                            <!-- Номер дома -->
                            <div class="col-md-6">
                                <label for="houseNumber" class="form-label">Номер дома <span
                                        class="text-danger">*</span></label>
                                <input class="form-control"
                                       type="text"
                                       name="houseNumber"
                                       id="houseNumber"
                                       placeholder="Введите номер дома"
                                       autofocus/>
                                <div class="invalid-feedback"></div>
                            </div>

                            <!-- Улица -->
                            <div class="col-md-6">
                                <label class="form-label" for="streetId">Улица <span class="text-danger">*</span></label>
                                <select name="streetId" id="streetId" class="form-select select2-street">
                                    <option value="">Выберите улицу</option>
                                </select>
                                <div class="invalid-feedback"></div>
                            </div>

                            <!-- Председатель -->
                            <div class="col-md-6">
                                <label class="form-label" for="chairmanId">Председатель</label>
                                <select name="chairmanId" id="chairmanId" class="form-select select2-chairman">
                                    <option value="">Выберите председателя</option>
                                </select>
                                <div class="invalid-feedback"></div>
                            </div>

                            <!-- Статус -->
                            <div class="col-md-6">
                                <label for="status" class="form-label">Статус <span class="text-danger">*</span></label>
                                <select name="status" id="status" class="form-select">
                                    <option value="">Выберите статус</option>
                                    <option value="NEW">Новый</option>
                                    <option value="ACTIVE">Активный</option>
                                    <option value="DEACTIVATED">Деактивирован</option>
                                    <option value="BLOCKED">Заблокирован</option>
                                </select>
                                <div class="invalid-feedback"></div>
                            </div>
                        </div>

                        <div class="mt-10">
                            <button type="submit" class="btn btn-primary me-3">Сохранить изменения</button>
                            <button type="reset" class="btn btn-label-secondary">Отмена</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div>
    <th:block layout:fragment="page_js">
        <script>
            $(document).ready(function () {
                // Инициализация Select2 для улиц
                $('#streetId').select2({
                    placeholder: 'Выберите улицу',
                    allowClear: true,
                    ajax: {
                        url: '/streets/search',
                        dataType: 'json',
                        delay: 250,
                        data: function (params) {
                            return {
                                q: params.term,
                                page: params.page || 1
                            };
                        },
                        processResults: function (data, params) {
                            return {
                                results: data.map(function (street) {
                                    return {
                                        id: street.id,
                                        text: street.name + ' (' + (street.city ? street.city.name : '') + ')'
                                    };
                                }),
                                pagination: {
                                    more: false
                                }
                            };
                        },
                        cache: true
                    },
                    minimumInputLength: 0
                });

                // Инициализация Select2 для председателей
                $('#chairmanId').select2({
                    placeholder: 'Выберите председателя',
                    allowClear: true,
                    ajax: {
                        url: '/chairmen/search',
                        dataType: 'json',
                        delay: 250,
                        data: function (params) {
                            return {
                                q: params.term,
                                page: params.page || 1
                            };
                        },
                        processResults: function (data, params) {
                            return {
                                results: data.map(function (chairman) {
                                    return {
                                        id: chairman.id,
                                        text: chairman.fullName || (chairman.lastName + ' ' + chairman.firstName)
                                    };
                                }),
                                pagination: {
                                    more: false
                                }
                            };
                        },
                        cache: true
                    },
                    minimumInputLength: 0
                });

                // Variables
                let isEditMode = false;
                let houseId = null;
                let currentHouse = null;

                // Form elements
                const houseForm = document.getElementById('formHouseSettings');
                const houseIdField = document.getElementById('houseId');

                // Form fields
                const fields = {
                    houseNumber: document.getElementById('houseNumber'),
                    streetId: document.getElementById('streetId'),
                    chairmanId: document.getElementById('chairmanId'),
                    status: document.getElementById('status')
                };

                // Initialize page
                init();

                async function init() {
                    try {
                        const path = window.location.pathname;
                        if (path.includes('/edit/')) {
                            isEditMode = true;
                            houseId = path.split('/edit/')[1];
                            await loadHouseData();
                        }

                        await loadStatuses();

                        // Setup event listeners
                        setupEventListeners();

                        // If edit mode, populate form
                        if (isEditMode && currentHouse) {
                            await populateForm(currentHouse);
                        }

                    } catch (error) {
                        console.error('Initialization error:', error);
                        showNotification('Ошибка при инициализации страницы', 'error');
                    }
                }

                async function loadHouseData() {
                    try {
                        const response = await fetch(`/houses/getHouse/${houseId}`);
                        if (response.ok) {
                            currentHouse = await response.json();
                        } else {
                            throw new Error('Дом не найден');
                        }
                    } catch (error) {
                        console.error('Error loading house:', error);
                        showNotification('Ошибка при загрузке данных дома', 'error');
                    }
                }

                async function loadStatuses() {
                    try {
                        const response = await fetch('/houses/getStatuses');
                        if (response.ok) {
                            const statuses = await response.json();
                            populateStatusSelect(statuses);
                        }
                    } catch (error) {
                        console.error('Error loading statuses:', error);
                    }
                }

                function populateStatusSelect(statuses) {
                    const statusSelect = fields.status;
                    statusSelect.innerHTML = '<option value="">Выберите статус</option>';

                    const statusLabels = {
                        'NEW': 'Новый',
                        'ACTIVE': 'Активный',
                        'DEACTIVATED': 'Деактивирован',
                        'BLOCKED': 'Заблокирован'
                    };

                    statuses.forEach(status => {
                        const option = document.createElement('option');
                        option.value = status;
                        option.textContent = statusLabels[status] || status;
                        statusSelect.appendChild(option);
                    });
                }

                function setSelect2Value(selectElement, data) {
                    if (!data || !data.id) return Promise.resolve();

                    return new Promise((resolve) => {
                        if (selectElement.find(`option[value="${data.id}"]`).length) {
                            selectElement.val(data.id).trigger('change');
                            resolve();
                        } else {
                            const option = new Option(data.text, data.id, true, true);
                            selectElement.append(option);
                            selectElement.one('select2:select', () => resolve());
                            selectElement.trigger({
                                type: 'select2:select',
                                params: { data: data }
                            });
                            setTimeout(resolve, 50);
                        }
                    });
                }

                async function populateForm(house) {
                    try {
                        console.log('Populating form with house:', house);

                        // Заполнение простых полей
                        if (house.houseNumber) fields.houseNumber.value = house.houseNumber;
                        if (house.status) fields.status.value = house.status;

                        // Set house ID
                        if (houseIdField) houseIdField.value = house.id;

                        // Устанавливаем улицу
                        if (house.street?.id) {
                            await setSelect2Value($(fields.streetId), {
                                id: house.street.id,
                                text: house.street.name + ' (' + (house.street.city ? house.street.city.name : '') + ')'
                            });
                        }

                        // Устанавливаем председателя
                        if (house.chairman?.id) {
                            await setSelect2Value($(fields.chairmanId), {
                                id: house.chairman.id,
                                text: house.chairman.fullName
                            });
                        }

                        console.log('Form populated successfully');

                    } catch (error) {
                        console.error('Error populating form:', error);
                        showNotification('Ошибка при заполнении формы', 'error');
                    }
                }

                function setupEventListeners() {
                    // Form submit
                    houseForm.addEventListener('submit', handleFormSubmit);

                    // Cancel button
                    const cancelBtn = document.querySelector('button[type="reset"]');
                    if (cancelBtn) {
                        cancelBtn.addEventListener('click', function(e) {
                            e.preventDefault();
                            window.history.back();
                        });
                    }
                }

                async function handleFormSubmit(e) {
                    e.preventDefault();

                    try {
                        // Show loading state
                        const submitBtn = houseForm.querySelector('button[type="submit"]');
                        const originalText = submitBtn.textContent;
                        submitBtn.disabled = true;
                        submitBtn.textContent = 'Сохранение...';

                        // Prepare form data
                        const formData = {
                            houseNumber: fields.houseNumber.value,
                            streetId: $(fields.streetId).val(),
                            chairmanId: $(fields.chairmanId).val() || null,
                            status: fields.status.value
                        };

                        if (isEditMode) {
                            formData.id = houseId;
                        }

                        console.log('Form data being sent:', formData);

                        // API endpoint and method
                        const url = isEditMode ? `/houses/${houseId}` : '/houses/create';
                        const method = isEditMode ? 'PUT' : 'POST';

                        console.log(`Sending ${method} request to ${url}`);

                        const response = await fetch(url, {
                            method: method,
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(formData)
                        });

                        if (response.ok) {
                            const result = await response.json();
                            console.log('Success response:', result);
                            showNotification(
                                isEditMode ? 'Дом успешно обновлен' : 'Дом успешно создан',
                                'success'
                            );

                            // Redirect to house list
                            setTimeout(() => {
                                window.location.href = '/houses';
                            }, 1500);
                        } else {
                            const errorData = await response.json();
                            console.error('Error response:', errorData);
                            handleValidationErrors(errorData);
                        }

                    } catch (error) {
                        console.error('Form submission error:', error);
                        showNotification('Ошибка при сохранении данных', 'error');
                    } finally {
                        // Restore button state
                        const submitBtn = houseForm.querySelector('button[type="submit"]');
                        submitBtn.disabled = false;
                        submitBtn.textContent = originalText;
                    }
                }

                function handleValidationErrors(errorData) {
                    // Clear previous errors
                    clearValidationErrors();

                    if (errorData.fieldErrors) {
                        Object.keys(errorData.fieldErrors).forEach(fieldName => {
                            const field = fields[fieldName];
                            if (field) {
                                const errorContainer = field.parentElement.querySelector('.invalid-feedback');
                                if (errorContainer) {
                                    field.classList.add('is-invalid');
                                    errorContainer.textContent = errorData.fieldErrors[fieldName];
                                }
                            }
                        });
                    } else {
                        showNotification(errorData.message || 'Ошибка валидации данных', 'error');
                    }
                }

                function clearValidationErrors() {
                    Object.values(fields).forEach(field => {
                        if (field) {
                            field.classList.remove('is-invalid');
                            const errorContainer = field.parentElement.querySelector('.invalid-feedback');
                            if (errorContainer) {
                                errorContainer.textContent = '';
                            }
                        }
                    });
                }

                function showNotification(message, type = 'info') {
                    // Используем toast.js для уведомлений
                    let title = '';
                    switch(type) {
                        case 'error':
                            title = 'Ошибка';
                            break;
                        case 'success':
                            title = 'Успех';
                            break;
                        case 'warning':
                            title = 'Предупреждение';
                            break;
                        default:
                            title = 'Информация';
                    }
                    showToast(type, title, message);
                }
            });
        </script>
    </th:block>
</div>

</body>
</html>

